#include <stdio.h>
#include <math.h>

#define LMAX 512 //Tamanho máx. do array de amostras
#define Ts 0.000125 //Tempo de amostragem
#define fc_lo 100 //Frequência de corte do filtro passa alta
#define fc_hi 900 //Frequência de corte do filtro passa alta
#define fd 100 //Distância mínima, em Hz, entre cada pico do espectro de fourier

typedef struct{
  int x;
  float y;
} Point;

void double_swap(float *a, float *b)
{
  float temp = *a;
  *a = *b;
  *b = temp;
}

void fft(float *data, const int n, const int isign)
{
  int nn, mmax, m, j, istep, i;
  float wtemp, wr, wpr, wpi, wi, theta, tempr, tempi;
  nn = n << 1;
  j = 1;
  for(i = 1; i < nn; i+=2) {
    if(j > i) {
      double_swap(&data[j-1], &data[i-1]);
      double_swap(&data[j], &data[i]);
    }
    m = n;
    while(m >= 2 && j > m) {
      j -= m;
      m >>= 1;
    }
    j += m;
  }

  mmax = 2;
  while(nn > mmax) {
    istep = mmax << 1;
    theta = isign*(6.28318530717959/mmax);
    wtemp = sin(0.5*theta);
    wpr = -2.0*wtemp*wtemp;
    wpi = sin(theta);
    wr = 1.0;
    wi = 0.0;
    for(m = 1; m < mmax; m += 2) {
      for(i = m; i <= nn; i += istep) {
        j = i+mmax;
        tempr = wr*data[j-1]-wi*data[j];
        tempi = wr*data[j]+wi*data[j-1];
        data[j-1] = data[i-1]-tempr;
        data[j] = data[i]-tempi;
        data[i-1] += tempr;
        data[i] += tempi;
      }
      wr = (wtemp = wr)*wpr-wi*wpi+wr;
      wi = wi*wpr+wtemp*wpi+wi;
    }
    mmax = istep;
  }
}

void point_swap(Point *a, Point *b)
{
  Point temp = *a;
  *a = *b;
  *b = temp;
}

void heapify(Point *arr, int n, int i)
{
  int largest = i;
  int l = 2 * i + 1;
  int r = 2 * i + 2;

  if(l < n && arr[l].y < arr[largest].y)
    largest = l;

  if(r < n && arr[r].y < arr[largest].y)
    largest = r;

  if(largest != i) {
    point_swap(&arr[i], &arr[largest]);

    heapify(arr, n, largest);
  }
}

void heapsort(Point *arr, int n)
{
  for(int i = n / 2 - 1; i >= 0; i--)
    heapify(arr, n, i);

  for(int i = n - 1; i > 0; i--) {
    point_swap(&arr[0], &arr[i]);

    heapify(arr, i, 0);
  }
}

float f0(float *data, const int L, const float threshold)
{
  //Range [left, rigth] do array onde o pico será detectado
  int left = (int)(fc_lo*L*Ts)*2, rigth = (int)(fc_hi*L*Ts)*2, delta = fd*L*Ts;
  int l = (rigth-left)/2 + 1;

  //Array do espectro bilateral de fourier
  Point data_fft[l];

  //Construção do espectro bilateral de fourier
  for(int i = left; i <= rigth; i += 2) {
    data_fft[(i-left)/2].x = i/2;
    data_fft[(i-left)/2].y = sqrt(data[i]*data[i] + data[i+1]*data[i+1]);
  }

  heapsort(data_fft, l); //Ordenação de modo decrescente

  Point pico = data_fft[0];
  float ymax = pico.y;
  
  for(int i = 0; i < l; i++) {

    if((data_fft[i].y/ymax) < threshold)
      break;

    if((pico.x - data_fft[i].x) >= delta) {
      pico = data_fft[i];
    }

  }

  return pico.x/(L*Ts);
}

void app_main(void)
{  
  //Array dos dados lidos
  float data[2*LMAX] = {2100, 0, 2517, 0, 2767, 0, 2928, 0, 2970, 0, 2906, 0, 2768, 0, 2559, 0, 2379, 0, 2263, 0, 2096, 0, 2023, 0, 1998, 0, 2006, 0, 2073, 0, 2096, 0, 2098, 0, 2115, 0, 2110, 0, 2086, 0, 2004, 0, 1920, 0, 1841, 0, 1755, 0, 1647, 0, 1574, 0, 1554, 0, 1596, 0, 1683, 0, 1807, 0, 1973, 0, 2107, 0, 2513, 0, 2751, 0, 2898, 0, 2941, 0, 2879, 0, 2719, 0, 2529, 0, 2336, 0, 2256, 0, 2102, 0, 2001, 0, 1979, 0, 2004, 0, 2047, 0, 2071, 0, 2085, 0, 2089, 0, 2095, 0, 2032, 0, 1980, 0, 1890, 0, 1829, 0, 1714, 0, 1642, 0, 1568, 0, 1535, 0, 1599, 0, 1681, 0, 1811, 0, 1975, 0, 2095, 0, 2513, 0, 2767, 0, 2919, 0, 2955, 0, 2875, 0, 2729, 0, 2527, 0, 2324, 0, 2266, 0, 2094, 0, 2013, 0, 2001, 0, 2038, 0, 2067, 0, 2093, 0, 2096, 0, 2115, 0, 2112, 0, 2096, 0, 1989, 0, 1921, 0, 1846, 0, 1746, 0, 1646, 0, 1583, 0, 1579, 0, 1610, 0, 1691, 0, 1833, 0, 1988, 0, 2229, 0, 2559, 0, 2815, 0, 2971, 0, 2997, 0, 2903, 0, 2749, 0, 2547, 0, 2343, 0, 2269, 0, 2105, 0, 2037, 0, 2000, 0, 2033, 0, 2096, 0, 2085, 0, 2091, 0, 2143, 0, 2151, 0, 2112, 0, 2077, 0, 1963, 0, 1858, 0, 1775, 0, 1664, 0, 1600, 0, 1584, 0, 1637, 0, 1726, 0, 1857, 0, 2033, 0, 2257, 0, 2602, 0, 2827, 0, 2960, 0, 3005, 0, 2917, 0, 2739, 0, 2551, 0, 2348, 0, 2284, 0, 2108, 0, 2043, 0, 2027, 0, 2058, 0, 2084, 0, 2088, 0, 2097, 0, 2131, 0, 2117, 0, 2096, 0, 2002, 0, 1935, 0, 1845, 0, 1742, 0, 1629, 0, 1563, 0, 1562, 0, 1606, 0, 1696, 0, 1821, 0, 1982, 0, 2191, 0, 2558, 0, 2807, 0, 2951, 0, 2979, 0, 2884, 0, 2733, 0, 2539, 0, 2317, 0, 2255, 0, 2095, 0, 2000, 0, 2003, 0, 2015, 0, 2058, 0, 2082, 0, 2096, 0, 2096, 0, 2105, 0, 2102, 0, 1984, 0, 1902, 0, 1808, 0, 1703, 0, 1609, 0, 1527, 0, 1521, 0, 1579, 0, 1694, 0, 1826, 0, 1999, 0, 2219, 0, 2559, 0, 2803, 0, 2931, 0, 2961, 0, 2855, 0, 2699, 0, 2509, 0, 2303, 0, 2162, 0, 2085, 0, 2004, 0, 2009, 0, 2022, 0, 2064, 0, 2094, 0, 2105, 0, 2128, 0, 2110, 0, 2099, 0, 1981, 0, 1920, 0, 1808, 0, 1739, 0, 1626, 0, 1554, 0, 1535, 0, 1604, 0, 1701, 0, 1825, 0, 2007, 0, 2253, 0, 2559, 0, 2814, 0, 2969, 0, 2982, 0, 2897, 0, 2731, 0, 2543, 0, 2337, 0, 2259, 0, 2103, 0, 2043, 0, 2011, 0, 2037, 0, 2077, 0, 2100, 0, 2109, 0, 2137, 0, 2128, 0, 2101, 0, 2008, 0, 1939, 0, 1838, 0, 1733, 0, 1642, 0, 1584, 0, 1569, 0, 1624, 0, 1715, 0, 1857, 0, 2019, 0, 2256, 0, 2587, 0, 2839, 0, 3011, 0, 3024, 0, 2919, 0, 2751, 0, 2559, 0, 2353, 0, 2263, 0, 2114, 0, 2089, 0, 2017, 0, 2065, 0, 2083, 0, 2100, 0, 2107, 0, 2133, 0, 2128, 0, 2102, 0, 2077, 0, 1935, 0, 1844, 0, 1735, 0, 1645, 0, 1579, 0, 1535, 0, 1594, 0, 1696, 0, 1813, 0, 1989, 0, 2117, 0, 2549, 0, 2775, 0, 2943, 0, 2977, 0, 2892, 0, 2731, 0, 2535, 0, 2327, 0, 2259, 0, 2096, 0, 2001, 0, 1991, 0, 2015, 0, 2073, 0, 2083, 0, 2097, 0, 2096, 0, 2101, 0, 2096, 0, 1980, 0, 1887, 0, 1818, 0, 1728, 0, 1612, 0, 1535, 0, 1526, 0, 1582, 0, 1669, 0, 1813, 0, 1983, 0, 2145, 0, 2546, 0, 2786, 0, 2928, 0, 2955, 0, 2863, 0, 2702, 0, 2508, 0, 2301, 0, 2145, 0, 2091, 0, 1978, 0, 1983, 0, 2000, 0, 2033, 0, 2079, 0, 2084, 0, 2113, 0, 2113, 0, 2085, 0, 1999, 0, 1914, 0, 1838, 0, 1712, 0, 1627, 0, 1535, 0, 1532, 0, 1578, 0, 1673, 0, 1824, 0, 1970, 0, 2118, 0, 2545, 0, 2801, 0, 2935, 0, 2981, 0, 2896, 0, 2736, 0, 2544, 0, 2322, 0, 2263, 0, 2081, 0, 2013, 0, 2018, 0, 2047, 0, 2085, 0, 2098, 0, 2097, 0, 2128, 0, 2120, 0, 2102, 0, 2001, 0, 1934, 0, 1847, 0, 1750, 0, 1648, 0, 1575, 0, 1570, 0, 1607, 0, 1703, 0, 1835, 0, 1991, 0, 2109, 0, 2538, 0, 2791, 0, 2943, 0, 2997, 0, 2925, 0, 2771, 0, 2589, 0, 2379, 0, 2284, 0, 2119, 0, 2096, 0, 2022, 0, 2064, 0, 2087, 0, 2095, 0, 2143, 0, 2174, 0, 2146, 0, 2105, 0, 2096, 0, 1950, 0, 1872, 0, 1776, 0, 1663, 0, 1578, 0, 1535, 0, 1584, 0, 1682, 0, 1823, 0, 1968, 0, 2102, 0, 2523, 0, 2779, 0, 2950, 0, 2998, 0, 2931, 0, 2775, 0, 2559, 0, 2357, 0, 2266, 0, 2095, 0, 2003, 0, 1999, 0, 2022, 0, 2075, 0, 2082, 0, 2094, 0, 2096, 0, 2114, 0, 2095, 0, 2005, 0, 1926, 0, 1858, 0, 1744, 0, 1638, 0, 1535, 0, 1518, 0, 1562, 0, 1655, 0, 1805, 0, 1951, 0, 2101, 0, 2511, 0, 2763, 0, 2933, 0, 2979, 0, 2887, 0, 2738, 0, 2549, 0, 2347, 0, 2261, 0, 2091, 0, 1985, 0, 1973, 0, 1995, 0, 2028, 0, 2083, 0, 2096, 0, 2099, 0, 2128, 0, 2105, 0, 2014, 0, 1921, 0, 1840, 0, 1738, 0, 1627, 0, 1535, 0, 1525, 0, 1559, 0, 1646, 0, 1783, 0, 1955, 0, 2087, 0, 2479, 0, 2753, 0, 2927, 0, 2983, 0, 2916, 0, 2763, 0, 2559, 0, 2373, 0, 2261, 0, 2099, 0, 2031, 0, 2003, 0, 2018, 0, 2069, 0, 2097, 0, 2114, 0, 2139, 0, 2143, 0, 2114, 0, 2087, 0, 1983, 0, 1886, 0, 1790, 0, 1671, 0, 1584, 0, 1564, 0, 1581, 0, 1652, 0, 1774, 0, 1936, 0, 2096, 0, 2447, 0, 2741, 0, 2921, 0, 2991, 0, 2943, 0, 2832, 0, 2639, 0, 2419, 0, 2266, 0, 2115, 0, 2096, 0, 2023, 0, 2035, 0, 2075, 0, 2093, 0};

  for(int i = 0; i < 2*LMAX; i += 2) {
    data[i] /= 1000.0;
  }

  //Execução da fft
  fft(data, LMAX, 1);

  printf("%f\n", f0(data, LMAX, 0.5));
}